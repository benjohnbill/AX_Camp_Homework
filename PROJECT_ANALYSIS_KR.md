# 현재 코드 분석 (초등학생도 이해하기 쉽게)

## 1) 이 프로젝트는 왜 만들었을까?

이 프로젝트는 **내 생각과 감정을 매일 기록**하고, AI가 그 기록들을 다시 보여주면서
"내가 어떤 사람인지"를 더 잘 보게 도와주려고 만들어졌어요.

쉽게 말하면,
- 내 마음속 말을 일기처럼 남기고,
- AI가 예전 기록과 지금 기록을 이어서,
- 내가 잘하고 있는지, 약속을 지키는지 확인해주는
**자기 성찰(나를 돌아보기) 앱**이에요.

코드와 문서에서도 "self-reflection"(자기 성찰) 목적이 분명히 나와 있어요.

---

## 2) 누구를 위한 프로젝트일까?

이 앱은 이런 사람을 위한 거예요.

- 매일 생각을 기록하고 싶은 사람
- 내 가치(헌법)와 행동이 맞는지 점검하고 싶은 사람
- 목표를 세우고, 어겼을 때 이유를 쓰며 다시 고치고 싶은 사람
- 감정/패턴을 데이터로 보고 싶은 사람

즉, **공부용/생산성용 도구**이면서도,
**마음 관리 도구** 역할도 같이 해요.

---

## 3) 핵심 기능과 가치

### 핵심 기능

1. **Stream 모드 (채팅 기록)**
   - 사용자가 문장을 입력하면 기록(Fragment)으로 저장해요.
   - 첫 입력은 조용히 저장하고,
   - 그 다음부터는 비슷한 과거 기록을 찾아 AI가 답해줘요.

2. **Red Protocol (위반/속죄 시스템)**
   - 헌법(내 원칙)을 어기면 Red Mode가 켜져요.
   - 이때는 일반 대화보다 먼저
     100자 이상 해명 + 내일의 약속을 제출해야 해요.

3. **Gatekeeper (앱 시작 점검)**
   - 앱 시작 시 최근 기록과 헌법의 관계를 보고,
   - 모순이나 어제의 약속 문제를 알림으로 보여줘요.

4. **Universe 모드 (시각화)**
   - 기록들을 별자리처럼 그래프로 보여줘요.
   - Constitution(핵심 가치) - Apology(해명) - Fragment(일상 기록)
     구조가 눈에 보이도록 만들었어요.

5. **Chronos/Control/Desk 모드**
   - Chronos: 타이머 후 어떤 헌법에 시간을 썼는지 도킹
   - Control: 칸반으로 생각 카드(draft→orbit→landed) 관리
   - Desk: 카드/기록을 모아 에세이 작성

### 핵심 가치

- "기록"을 "성장 데이터"로 바꿈
- 감정적인 느낌뿐 아니라 **근거(로그/유사도/통계)**로 나를 봄
- "오늘의 나"와 "과거의 나"를 연결해
  **지속적인 자기 개선 루프**를 만들어요.

---

## 4) 기술적인 데이터 플로우 (아주 쉽게)

아래는 "사용자가 글을 쓸 때" 데이터가 움직이는 길이에요.

1. **사용자 입력**
   - Streamlit 화면(app.py)에서 텍스트 입력

2. **로직 레이어 호출**
   - app.py가 narrative_logic.py 함수 호출
   - 예: `save_log`, `find_related_logs`, `generate_response`

3. **AI 처리**
   - `get_embedding`: 문장을 숫자 벡터로 변환
   - `extract_metadata`: 키워드/감정/차원 추출
   - `generate_response`: 관련 과거 로그를 컨텍스트로 LLM 응답 생성

4. **DB 저장**
   - db_manager.py의 `create_log`가 SQLite `logs` 테이블에 저장
   - 임베딩은 바이너리(BLOB), 키워드는 JSON 문자열로 저장
   - 필요한 경우 `chat_history`, `connections`, `user_stats`도 업데이트

5. **조회/분석/시각화**
   - `get_all_logs`, `get_fragments_paginated`, `get_kanban_cards` 등으로 읽기
   - Plotly/PyVis로 히트맵, 트리맵, 그래프 렌더링

6. **규칙 시스템 반영**
   - `debt_count`가 0보다 크면 Red Mode
   - 사과(Apology) 처리 시 debt 감소
   - 로그인 시 streak 업데이트

정리하면,

**UI(app.py) → AI/비즈니스 로직(narrative_logic.py) → 저장소(db_manager.py/SQLite) → 다시 UI로 시각화**

이 흐름으로 계속 돌아가요.

